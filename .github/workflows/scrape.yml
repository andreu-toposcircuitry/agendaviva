name: Daily Scrape

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          
      # ðŸ‘‡ FIXED: Added --no-frozen-lockfile to ignore the lockfile mismatch
      - run: pnpm install --no-frozen-lockfile
      
      # Build dependencies
      - run: pnpm exec turbo run build --filter=@agendaviva/scraper...

      # 1. Run Discovery (Find new sources)
      - run: pnpm --filter @agendaviva/scraper discover
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          BRAVE_API_KEY: ${{ secrets.BRAVE_API_KEY }}
          # We provide a fake key here because the app checks for it on startup, 
          # even though the discovery script doesn't actually use it.
          OPENAI_API_KEY: "sk-dummy-key-just-for-validation-pass"

      # 2. Run Scraper (Process active sources)
      - run: pnpm --filter @agendaviva/scraper scrape
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
